<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>è‡ªå®šä¹‰åç§°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="color-scheme" content="light dark" />
    <link href="/assets/css/style.css" rel="stylesheet" type="text/css" />
    <script src="/assets/js/script.js"></script>
</head>
<body>

    <div class="card">

        <div class="top-bar">
            <div class="nav-brand">
                <img class="logo-small" src="/favicon.png" alt="è‡ªå®šä¹‰åç§°" />
                <span id="visualTitle" class="page-title-text">æ”¶é“¶å°</span>
            </div>
            <div id="headerMenuContainer"></div>
        </div>

        <div class="cardin center animate">
            <div id="checkoutSection">

                <div class="order-item" style="display: block;">
                    <div class="info-row" style="align-items: center;">
                        <h2>è´¦æˆ·çŠ¶æ€</h2>
                        <div class="header-btn-wrap">
                            <button id="refreshBtn" class="form-button primary mini-action-btn" onclick="refreshAll()">
                                <span class="btn__label">åˆ·æ–°æ•°æ®</span>
                            </button>
                        </div>
                    </div>
                    <div class="info-row" style="margin-bottom: 0;">
                        <span>æŒæœ‰ä½™é¢: <span id="balVal" style="font-weight: 600; color: var(--primary-color);">ï¿¥0.00</span></span>
                    </div>
                    <a href="/overview/"><button class="form-button primary"><span class="btn__label">å›åˆ°ä»ªè¡¨ç›˜</span></button></a>
                </div>

                <div class="order-item" style="display: block;">
                    <div class="info-row" style="margin-bottom: 5px;">
                        <h2 id="orderTitle">æ­£åœ¨æ£€æŸ¥è®¢å•</h2>
                    </div>
                    <div class="h20"></div>
                    <div id="orderList" style="text-align: left; min-height: 40px;"></div>

                    <div id="guidanceLine" class="guide-text hidden" style="text-align: center; margin-top: 15px; border-top: 1px solid rgba(128,128,128,0.1); padding-top: 10px;"></div>
                    
                    <div id="payActionContainer"></div>
                </div>

                <div class="order-item" style="display: block;">
                    <div class="info-row" style="margin-bottom: 5px; align-items: center;">
                        <h2>å……å€¼ä¸å…‘æ¢</h2>
                        <div class="header-btn-wrap">
                            <a href="https://å‘å¡åœ°å€" target="_blank" class="form-button primary mini-action-btn">
                                <span class="btn__label">æ²¡æœ‰ç¤¼å“å¡ï¼Ÿç«‹å³è´­ä¹°</span>
                            </a>
                        </div>
                    </div>
                    <div class="h10"></div>
                    <div class="sub-url-box">
                        <input type="text" id="code" class="sub-url-input" placeholder="è¾“å…¥ç¤¼å“å¡ä»£ç " />
                    </div>
                    <div class="h10"></div>
                    <button id="redeemBtn" class="form-button primary"><span class="btn__label">å…‘æ¢</span></button>
                    
                    <div class="h20"></div>
                    <div class="sub-url-box" style="margin-top: 0; opacity: 0.7;">
                        <input type="text" id="statusBox" class="sub-url-input" value="FrostPeak æ”¶é“¶å°" readonly style="text-align: center;" />
                    </div>
                </div>

                <div class="h20"></div>

            </div>
        </div>
    </div>

    <script>

        let currentBalance = 0;
        const sessionPaidSet = new Set();
        const setStatus = (t) => { if (document.getElementById('statusBox')) document.getElementById('statusBox').value = t; };

        // ä»…æ›´æ–°ä½™é¢æ˜¾ç¤º
        async function updateBalanceOnly() {
            try {
                const res = await fetch(`${API_BASE}/api/v1/user/info`, { headers: { 'Authorization': authToken } });
                const d = await res.json();
                if (d.data) {
                    currentBalance = d.data.balance;
                    if (document.getElementById('balVal')) document.getElementById('balVal').innerText = `ï¿¥${(currentBalance / 100).toFixed(2)}`;
                }
            } catch (e) { console.error("Balance Update Error"); }
        }

        // åˆ·æ–°è®¢å•åˆ—è¡¨ä¸ä½™é¢
        async function refreshAll() {
            const refreshBtnLabel = document.querySelector('#refreshBtn .btn__label');
            const refreshBtn = document.getElementById('refreshBtn');
            
            if (refreshBtnLabel && refreshBtnLabel.innerText === "â€¢â€¢â€¢") return;
            if (refreshBtnLabel) refreshBtnLabel.innerText = "â€¢â€¢â€¢";
            if (refreshBtn) refreshBtn.disabled = true;

            try {
                await updateBalanceOnly();
                const oRes = await fetch(`${API_BASE}/api/v1/user/order/fetch?status=0`, { headers: { 'Authorization': authToken } });
                const oData = await oRes.json();
                renderOrders(oData.data || []);
            } catch (e) { console.error("Refresh Error"); }
            finally { 
                if (refreshBtnLabel) refreshBtnLabel.innerText = "åˆ·æ–°æ•°æ®"; 
                if (refreshBtn) refreshBtn.disabled = false;
            }
        }

        // æ¸²æŸ“è®¢å•åˆ—è¡¨ DOM
        function renderOrders(orders) {
            const list = document.getElementById('orderList');
            const title = document.getElementById('orderTitle');
            const guide = document.getElementById('guidanceLine');
            const payContainer = document.getElementById('payActionContainer');
            
            if (!list) return;
            list.innerHTML = '';
            payContainer.innerHTML = ''; 
            
            if (orders.length === 0) {
                title.innerText = "æ²¡æœ‰å¾…æ”¯ä»˜è®¢å•";
                list.innerHTML = '<p class="sub" style="margin-top: 10px; opacity: 0.6; text-align: center;">æš‚æ— å¾…æ”¯ä»˜è®¢å•</p>';
                if (guide) guide.classList.add('hidden');
            } else {
                title.innerText = "å¾…æ”¯ä»˜è®¢å•";
                if (guide) { guide.classList.remove('hidden'); guide.classList.add('animate'); }
                
                let highestPrice = 0;
                
                orders.forEach(o => {
                    highestPrice = Math.max(highestPrice, o.total_amount);
                    const isP = sessionPaidSet.has(o.trade_no);
                    const enough = currentBalance >= o.total_amount;
                    
                    const item = document.createElement('div');
                    item.className = 'info-row animate'; 
                    item.style.borderBottom = '1px solid rgba(128,128,128,0.1)';
                    item.style.paddingBottom = '10px';
                    item.style.marginBottom = '10px';
                    
                    item.innerHTML = `
                        <div style="text-align: left;">
                            <div style="font-size:14px; font-weight:600; color: inherit;">${o.plan ? o.plan.name : "è®¢é˜…é¡¹ç›®"}</div>
                            <div style="font-size:12px; color:var(--text-secondary); margin-top:2px;">è®¢å•å·: ${o.trade_no.slice(-6)}</div>
                            <div style="font-size:12px; color:var(--text-secondary);">è¿˜éœ€è¦ ï¿¥${(o.total_amount / 100).toFixed(2)} çš„ä½™é¢</div>
                        </div>
                        <div style="text-align: right;">
                             <button id="cancelBtn_${o.trade_no}" class="form-button primary pay-btn-sm" 
                                style="margin:0;"
                                onclick="handleCancel('${o.trade_no}')">
                                <span class="btn__label">å…³é—­è®¢å•</span>
                            </button>
                        </div>
                    `;
                    list.appendChild(item);

                    const btnLabel = isP ? 'å·²æ”¯ä»˜' : (enough ? 'ç«‹å³æ”¯ä»˜' : 'ä½™é¢ä¸è¶³');
                    const isDisabled = (!enough && !isP) || isP; 
                    
                    payContainer.innerHTML = `
                        <button class="form-button primary ${isDisabled ? 'btn-disabled' : ''}" 
                            ${isDisabled ? 'disabled' : ''}
                            onclick="handlePay('${o.trade_no}', ${o.plan_id}, '${o.period}', this)">
                            <span class="btn__label">${btnLabel}</span>
                        </button>
                    `;
                });
                
                if(list.lastElementChild) list.lastElementChild.style.borderBottom = 'none';

                if (guide) guide.innerHTML = currentBalance >= highestPrice ? '<div class="h20"></div><span class="guide-success">ä½ çš„ä½™é¢å……è¶³ï¼Œå¯ä»¥å®Œæˆè®¢å•</span>' : '<div class="h20"></div><span>ä½™é¢ä¸è¶³ï¼Œè¯·å…ˆåœ¨ä¸‹æ–¹å……å€¼</span>';
            }
        }

        // å…³é—­è®¢å•é€»è¾‘
        async function handleCancel(tid) {
            const btn = event.target.closest('button');
            const label = btn.querySelector('.btn__label');
            if(btn) {
                btn.disabled = true;
                if(label) label.innerText = "Â·Â·Â·";
            }
            try {
                await fetch(`${API_BASE}/api/v1/user/order/cancel`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': authToken }, 
                    body: JSON.stringify({ trade_no: tid }) 
                });
                refreshAll();
            } catch (e) {
                refreshAll();
            }
        }

        // å¤„ç†æ”¯ä»˜è¯·æ±‚
        async function handlePay(tid, pid, per, btn) {
            const BALANCE_METHOD_ID = 1;
            const label = btn.querySelector('.btn__label');
            
            // ç¦ç”¨æ”¯ä»˜æŒ‰é’®
            btn.disabled = true; 
            label.innerText = "â€¢â€¢â€¢"; 
            setStatus("æ­£åœ¨æ“ä½œä¸­Â·Â·Â·");

            // ç¦ç”¨å¯¹åº”çš„â€œå…³é—­è®¢å•â€æŒ‰é’®
            const cancelBtn = document.getElementById(`cancelBtn_${tid}`);
            if (cancelBtn) cancelBtn.disabled = true;

            try {
                await fetch(`${API_BASE}/api/v1/user/order/cancel`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': authToken }, body: JSON.stringify({ trade_no: tid }) });
                const sRes = await fetch(`${API_BASE}/api/v1/user/order/save`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': authToken }, body: JSON.stringify({ plan_id: pid, period: per }) });
                const sData = await sRes.json();
                const pRes = await fetch(`${API_BASE}/api/v1/user/order/checkout`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': authToken }, body: JSON.stringify({ trade_no: sData.data, method: BALANCE_METHOD_ID }) });
                const pData = await pRes.json();

                if (pData.status === 'success' || pData.data === true) {
                    setStatus("âœ… æ“ä½œæˆåŠŸ");
                    sessionPaidSet.add(tid);
                    label.innerText = "å·²æ”¯ä»˜";
                    setTimeout(updateBalanceOnly, 500);
                    // æ”¯ä»˜æˆåŠŸä¸è§£ç¦å…³é—­æŒ‰é’®
                } else { throw new Error(); }
            } catch (e) {
                alert("æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•");
                label.innerText = "æ”¯ä»˜";
                btn.disabled = false;
                // å¤±è´¥æ—¶è§£ç¦å…³é—­æŒ‰é’®
                if (cancelBtn) cancelBtn.disabled = false;
                setStatus("FrostPeak æ”¶é“¶å°");
            }
        }

        // å¤„ç†ç¤¼å“å¡å…‘æ¢
        async function handleRedeem() {
            const code = document.getElementById('code').value.trim();
            if (!code) return;
            const btn = document.getElementById('redeemBtn');
            btn.disabled = true; btn.classList.add('btn--loading'); setStatus("æ­£åœ¨æ“ä½œä¸­Â·Â·Â·");
            try {
                const res = await fetch(`${API_BASE}/api/v1/user/gift-card/redeem`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': authToken }, body: JSON.stringify({ code }) });
                const d = await res.json();
                if (d.status === 'success') {
                    setStatus("ğŸ‰ å…‘æ¢æˆåŠŸ");
                    document.getElementById('code').value = '';
                    refreshAll();
                } else {
                    setStatus("âŒ " + d.message);
                }
            } catch (e) { setStatus("âš ï¸ é€šä¿¡é”™è¯¯"); } finally { btn.disabled = false; btn.classList.remove('btn--loading'); }
        }

        (function initCheckout() {
            injectMenu();
            const redeemBtn = document.getElementById('redeemBtn');
            if (redeemBtn) redeemBtn.addEventListener('click', handleRedeem);

            if (authToken) {
                refreshAll();
            }
        })();
    </script>
</body>
</html>